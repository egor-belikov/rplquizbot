<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Футбольная Викторина РПЛ</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; background-color: #f0f2f5; color: #333; }
        .container { text-align: center; background-color: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); width: 95%; max-width: 500px; }
        .hidden { display: none; }
        button { background-color: #007bff; color: white; border: none; padding: 12px 20px; border-radius: 8px; font-size: 1em; cursor: pointer; transition: background-color 0.2s; margin: 5px; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        .btn-secondary { background-color: #6c757d; }
        .btn-secondary:hover:not(:disabled) { background-color: #5a6268; }
        .btn-danger { background-color: #dc3545; }
        .btn-danger:hover:not(:disabled) { background-color: #c82333; }
        input[type="text"], input[type="password"] { width: 80%; padding: 10px; border-radius: 8px; border: 1px solid #ddd; margin-bottom: 10px; font-size: 1em; }
        h1, h2, h3 { margin-top: 0; }
        .error-message { color: #dc3545; }
        .auth-toggle { font-size: 0.9em; color: #007bff; cursor: pointer; text-decoration: underline; margin-top: 15px; }
        .lobby-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        /* Стили для лобби */
        .open-game-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border: 1px solid #eee; border-radius: 8px; margin-bottom: 8px; }
        .open-game-item .info { text-align: left; }
        .open-game-item .info .creator { font-weight: bold; }
        .open-game-item .info .details { font-size: 0.9em; color: #666; }
    </style>
</head>
<body>
    <div id="auth-screen" class="container">
        <div id="login-form-container">
            <h1>Вход</h1>
            <form id="login-form">
                <input type="text" id="login-nickname" placeholder="Никнейм" autocomplete="username">
                <input type="password" id="login-password" placeholder="Пароль" autocomplete="current-password">
                <button type="submit">Войти</button>
            </form>
            <div id="login-status" class="error-message"></div>
            <p class="auth-toggle" id="show-register-form">Нет аккаунта? Зарегистрироваться</p>
        </div>
        <div id="register-form-container" class="hidden">
            <h1>Регистрация</h1>
            <form id="register-form">
                <input type="text" id="register-nickname" placeholder="Придумайте никнейм" autocomplete="nickname">
                <input type="password" id="register-password" placeholder="Придумайте пароль" autocomplete="new-password">
                <button type="submit">Создать аккаунт</button>
            </form>
            <div id="register-status" class="error-message"></div>
            <p class="auth-toggle" id="show-login-form">Уже есть аккаунт? Войти</p>
        </div>
    </div>

    <div id="lobby-screen" class="container hidden">
        <div class="lobby-header">
            <p style="margin:0;">Привет, <b id="welcome-nickname"></b>!</p>
            <button id="logout-btn" class="btn-secondary" style="font-size:0.8em; padding: 6px 12px;">Выйти</button>
        </div>
        <button id="create-game-btn">Создать игру</button>
        <button id="leaderboard-btn">Рейтинг</button>
        <div class="open-games-container">
            <h3>Открытые игры:</h3>
            <div id="open-games-list"><p>Нет открытых игр. Создайте свою!</p></div>
        </div>
        <div class="training-modes">
            <h3>Тренировка</h3>
            <button id="solo-btn" class="btn-secondary">Играть одному</button>
            <button id="vs-bot-btn" class="btn-secondary">Играть с ботом</button>
        </div>
    </div>
    
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script>
        const socket = io();
        
        // --- DOM Элементы ---
        const authScreen = document.getElementById('auth-screen');
        const lobbyScreen = document.getElementById('lobby-screen');
        
        // Экраны
        const screens = {
            auth: document.getElementById('auth-screen'),
            lobby: document.getElementById('lobby-screen'),
            // Добавьте сюда другие экраны по мере необходимости
            config: document.getElementById('config-screen'),
            leaderboard: document.getElementById('leaderboard-screen'),
            game: document.getElementById('game-screen'),
        };

        // Формы аутентификации
        const loginFormContainer = document.getElementById('login-form-container');
        const registerFormContainer = document.getElementById('register-form-container');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const loginNickname = document.getElementById('login-nickname');
        const loginPassword = document.getElementById('login-password');
        const loginStatus = document.getElementById('login-status');
        const registerNickname = document.getElementById('register-nickname');
        const registerPassword = document.getElementById('register-password');
        const registerStatus = document.getElementById('register-status');
        const showRegisterFormBtn = document.getElementById('show-register-form');
        const showLoginFormBtn = document.getElementById('show-login-form');

        // Лобби
        const welcomeNickname = document.getElementById('welcome-nickname');
        const logoutBtn = document.getElementById('logout-btn');
        const createGameBtn = document.getElementById('create-game-btn');
        const leaderboardBtn = document.getElementById('leaderboard-btn');
        const openGamesList = document.getElementById('open-games-list');
        const soloBtn = document.getElementById('solo-btn');
        const vsBotBtn = document.getElementById('vs-bot-btn');

        let currentUserNickname = null;

        // --- Функции ---
        function showScreen(screenName) {
            Object.values(screens).forEach(screen => {
                if (screen) screen.classList.add('hidden');
            });
            if (screens[screenName]) {
                screens[screenName].classList.remove('hidden');
            }
        }

        // --- Обработчики событий ---

        // Переключение между формами входа и регистрации
        showRegisterFormBtn.addEventListener('click', () => {
            loginFormContainer.classList.add('hidden');
            registerFormContainer.classList.remove('hidden');
        });
        showLoginFormBtn.addEventListener('click', () => {
            registerFormContainer.classList.add('hidden');
            loginFormContainer.classList.remove('hidden');
        });

        // Отправка формы логина
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const nickname = loginNickname.value.trim();
            const password = loginPassword.value;
            loginStatus.textContent = "Проверка...";
            socket.emit('login_user', { nickname, password });
        });

        // Отправка формы регистрации
        registerForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const nickname = registerNickname.value.trim();
            const password = registerPassword.value;
            registerStatus.textContent = "Создание аккаунта...";
            socket.emit('register_user', { nickname, password });
        });

        // Выход из аккаунта
        logoutBtn.addEventListener('click', () => {
            currentUserNickname = null;
            localStorage.removeItem('rpl_quiz_nickname');
            
            loginNickname.value = '';
            loginPassword.value = '';
            registerNickname.value = '';
            registerPassword.value = '';
            loginStatus.textContent = '';
            registerStatus.textContent = '';

            showScreen('auth');
        });
        
        // Присоединение к игре из лобби
        openGamesList.addEventListener('click', (e) => {
            if (e.target.classList.contains('play-btn')) {
                const creatorSid = e.target.dataset.creatorSid;
                if (currentUserNickname) {
                    socket.emit('join_game', { creator_sid: creatorSid, nickname: currentUserNickname });
                } else {
                    alert("Ошибка: не удалось определить вашего пользователя. Попробуйте перезайти.");
                }
            }
        });

        // --- Обработчики Socket.IO ---

        // Ответ от сервера на попытку входа/регистрации
        socket.on('auth_status', (data) => {
            const statusDiv = document.getElementById(`${data.form}-status`);
            if (data.success) {
                currentUserNickname = data.nickname;
                localStorage.setItem('rpl_quiz_nickname', currentUserNickname);
                welcomeNickname.textContent = currentUserNickname;
                showScreen('lobby');
            } else {
                if (statusDiv) {
                    statusDiv.textContent = data.message;
                }
            }
        });
        
        // Обновление списка открытых игр в лобби
        socket.on('update_lobby', (data) => {
            openGamesList.innerHTML = '';
            if (!data || data.length === 0) {
                openGamesList.innerHTML = '<p>Нет открытых игр. Создайте свою!</p>';
                return;
            }
            data.forEach(game => {
                const gameItem = document.createElement('div');
                gameItem.className = 'open-game-item';
                const time_bank = game.settings.time_bank;
                const time_str = `${Math.floor(time_bank / 60)}:${String(time_bank % 60).padStart(2, '0')}`;
                gameItem.innerHTML = `
                    <div class="info">
                        <span class="creator">${game.creator_nickname} (${game.creator_rating})</span>
                        <div class="details">РПЛ, ${game.settings.num_rounds} раундов, ${time_str}</div>
                    </div>
                    <button class="play-btn" data-creator-sid="${game.creator_sid}">Играть</button>
                `;
                openGamesList.appendChild(gameItem);
            });
        });

        // --- Инициализация при загрузке страницы ---
        window.addEventListener('load', () => {
            const savedNickname = localStorage.getItem('rpl_quiz_nickname');
            if (savedNickname) {
                currentUserNickname = savedNickname;
                welcomeNickname.textContent = currentUserNickname;
                showScreen('lobby');
                // Запрос на обновление лобби будет отправлен автоматически при 'connect'
            } else {
                showScreen('auth');
            }
        });

    </script>
</body>
</html>