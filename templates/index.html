<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Футбольная Викторина РПЛ</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; background-color: #f0f2f5; color: #333; }
        .container { text-align: center; background-color: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); width: 95%; max-width: 500px; }
        .hidden { display: none; }
        button { background-color: #007bff; color: white; border: none; padding: 12px 20px; border-radius: 8px; font-size: 1em; cursor: pointer; transition: background-color 0.2s; margin: 5px; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        .btn-secondary { background-color: #6c757d; }
        .btn-secondary:hover:not(:disabled) { background-color: #5a6268; }
        .btn-danger { background-color: #dc3545; }
        .btn-danger:hover:not(:disabled) { background-color: #c82333; }
        input[type="text"], .config-row select { width: 80%; padding: 10px; border-radius: 8px; border: 1px solid #ddd; margin-bottom: 10px; font-size: 1em; }
        h1, h2, h3 { margin-top: 0; }
        #registration-status, #game-status, #pvp-status { min-height: 1.2em; margin-bottom: 10px; font-size: 0.9em; }
        .error-message { color: #dc3545; }
        .config-row { display: flex; justify-content: center; align-items: center; margin-bottom: 15px; }
        .config-row label { flex: 1; text-align: right; margin-right: 10px; }
        .config-row .input-group { flex: 2; display: flex; align-items: center; }
        .config-row .input-group input { text-align: center; width: 50px; margin: 0 5px; }
        .config-row .input-group button { font-size: 1.2em; padding: 0; width: 30px; height: 30px; line-height: 30px; }
        .open-games-container { margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px; }
        .open-game-item { display: flex; justify-content: space-between; align-items: center; background-color: #f8f9fa; padding: 10px; border-radius: 8px; margin-bottom: 10px; text-align: left; }
        .open-game-item .info { display: flex; flex-direction: column; gap: 2px; }
        .open-game-item .creator { font-weight: bold; }
        .open-game-item .details { font-size: 0.8em; color: #6c757d; }
        .open-game-item .play-btn { font-size: 0.9em; padding: 8px 16px; }
        .training-modes { margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px; }
        .training-modes h3 { font-size: 1em; color: #6c757d; margin-bottom: 10px; }
    </style>
</head>
<body>
    <div id="registration-screen" class="container hidden">...</div>
    <div id="lobby-screen" class="container hidden">
        <h1>Лобби</h1>
        <p>Привет, <b id="welcome-nickname"></b>!</p>
        <button id="create-game-btn">Создать игру</button>
        <button id="leaderboard-btn">Рейтинг</button>
        <div class="open-games-container">
            <h3>Открытые игры:</h3>
            <div id="open-games-list"></div>
        </div>
        <div class="training-modes">
            <h3>Тренировка</h3>
            <button id="solo-btn" class="btn-secondary">Играть одному</button>
            <button id="vs-bot-btn" class="btn-secondary">Играть с ботом</button>
        </div>
    </div>
    <div id="config-screen" class="container hidden">
        <h2>Настройки игры</h2>
        <div class="config-row">
            <label>Лига:</label>
            <div class="input-group"><select id="config-league" disabled><option>РПЛ</option></select></div>
        </div>
        <div class="config-row">
            <label>Время на раунд:</label>
            <div class="input-group">
                <button id="time-min-minus">-</button>
                <input type="text" id="config-time-min" value="1">
                <button id="time-min-plus">+</button>
                <span>:</span>
                <button id="time-sec-minus">-</button>
                <input type="text" id="config-time-sec" value="30">
                <button id="time-sec-plus">+</button>
            </div>
        </div>
        <div class="config-row">
            <label>Кол-во раундов:</label>
            <div class="input-group">
                <select id="config-rounds">
                    <option value="3">3</option>
                    <option value="5">5</option>
                    <option value="8">8</option>
                    <option value="16" selected>16</option>
                </select>
            </div>
        </div>
        <button id="submit-create-game-btn">Создать</button>
        <button id="back-to-lobby-btn" class="btn-secondary">Назад</button>
    </div>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script>
        const socket = io();
        const screens = { registration: document.getElementById('registration-screen'), mainMenu: document.getElementById('main-menu-screen'), leaderboard: document.getElementById('leaderboard-screen'), game: document.getElementById('game-screen'), summary: document.getElementById('summary-screen'), gameOver: document.getElementById('game-over-screen') };
        let currentUserNickname = null, clientState = {}, timerInterval;
        const registrationForm = document.getElementById('registration-form'), nicknameInput = document.getElementById('nickname-input'), registrationStatus = document.getElementById('registration-status'), welcomeNickname = document.getElementById('welcome-nickname');
        const soloBtn = document.getElementById('solo-btn'), vsBotBtn = document.getElementById('vs-bot-btn'), leaderboardBtn = document.getElementById('leaderboard-btn'), backToMenuBtn = document.getElementById('back-to-menu-btn'), leaderboardBody = document.getElementById('leaderboard-body'), pvpBtn = document.getElementById('pvp-btn'), pvpStatus = document.getElementById('pvp-status'), cancelPvpBtn = document.getElementById('cancel-pvp-btn');
        const gameHeader = document.getElementById('gameHeader'), scoreDisplay = document.getElementById('score-display'), gameStatus = document.getElementById('game-status'), guessForm = document.getElementById('guess-form'), guessInput = document.getElementById('guess-input'), liveNamedList = document.getElementById('live-named-list'), surrenderBtn = document.getElementById('surrender-btn'), submitGuessBtn = document.getElementById('submit-guess-btn');
        const myTimerBox = document.getElementById('my-timer-box'), myTimerNickname = document.getElementById('my-timer-nickname'), myTimerValue = document.getElementById('my-timer-value');
        const opponentTimerBox = document.getElementById('opponent-timer-box'), opponentTimerNickname = document.getElementById('opponent-timer-nickname'), opponentTimerValue = document.getElementById('opponent-timer-value');
        const summaryHeader = document.getElementById('summaryHeader'), summaryScoreDisplay = document.getElementById('summary-score-display'), summaryHumanColumn = document.getElementById('summary-human-column'), summaryBotColumn = document.getElementById('summary-bot-column'), summaryHumanNameHeader = document.getElementById('summary-human-name-header'), summaryBotNameHeader = document.getElementById('summary-bot-name-header'), summaryHumanNamedList = document.getElementById('summary-human-named-list'), summaryBotNamedList = document.getElementById('summary-bot-named-list'), summaryRemainingList = document.getElementById('summary-remaining-list'), summaryCountdown = document.getElementById('summary-countdown'), skipPauseBtn = document.getElementById('skip-pause-btn');
        const gameOverTitle = document.getElementById('game-over-title'), earlyEndExplanation = document.getElementById('early-end-explanation'), finalScoreDisplay = document.getElementById('final-score-display'), ratingChangesDisplay = document.getElementById('rating-changes-display'), gameHistoryTable = document.getElementById('game-history-table'), backToMenuFromGameOverBtn = document.getElementById('back-to-menu-from-game-over');
        
        let isMyTurn = false;

        function showScreen(screenName) { Object.values(screens).forEach(screen => screen.classList.add('hidden')); if (screens[screenName]) screens[screenName].classList.remove('hidden'); }
        
        function formatTime(seconds) {
            if (seconds < 0) seconds = 0;
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            const ms = Math.floor((seconds - Math.floor(seconds)) * 100);
            return `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}.${String(ms).padStart(2, '0')}`;
        }
        
        function updateGameUI(state) {
            clientState = state;
            let myPlayerIndex = -1;
            for (const i in state.players) { if (state.players[i].sid === socket.id) { myPlayerIndex = parseInt(i, 10); break; } }
            if (myPlayerIndex === -1 && state.mode === 'solo') myPlayerIndex = 0;
            if (myPlayerIndex === -1 && state.mode !== 'solo') return; 
            const opponentPlayerIndex = 1 - myPlayerIndex;
            const activePlayerIndex = state.currentPlayerIndex;
            isMyTurn = (myPlayerIndex === activePlayerIndex);
            gameHeader.textContent = `Тур ${state.round}/${state.totalRounds}: ${state.clubName}`;
            if (state.mode === 'solo' || !state.players[1]) {
                scoreDisplay.classList.add('hidden');
                opponentTimerBox.classList.add('hidden');
                myTimerNickname.textContent = state.players[0].nickname;
            } else {
                scoreDisplay.classList.remove('hidden');
                opponentTimerBox.classList.remove('hidden');
                scoreDisplay.textContent = `${state.players[0].nickname} ${state.scores[0]} : ${state.scores[1]} ${state.players[1].nickname}`;
                myTimerNickname.textContent = state.players[myPlayerIndex].nickname + ' (Вы)';
                opponentTimerNickname.textContent = state.players[opponentPlayerIndex].nickname;
            }
            submitGuessBtn.disabled = !isMyTurn;
            surrenderBtn.disabled = !isMyTurn;
            guessInput.placeholder = isMyTurn ? 'Введите фамилию...' : 'Ход соперника...';
            gameStatus.textContent = isMyTurn ? 'Ваш ход...' : `Ожидаем ход игрока ${state.players[activePlayerIndex].nickname}...`;
            if(isMyTurn) {
                surrenderBtn.classList.remove('btn-secondary');
                surrenderBtn.classList.add('btn-danger');
                guessInput.focus();
            } else {
                surrenderBtn.classList.remove('btn-danger');
                surrenderBtn.classList.add('btn-secondary');
            }
            liveNamedList.innerHTML = '';
            state.namedPlayers.forEach(player => {
                const pDiv = document.createElement('div'); pDiv.className = 'player-name';
                const author = (state.mode !== 'solo' && state.players[1]) ? (player.by === 0 ? state.players[0].nickname : state.players[1].nickname) : '';
                pDiv.textContent = author ? `${player.name} (${author})` : player.name;
                // --- ИЗМЕНЕНИЕ: Добавляем в начало, а не в конец ---
                liveNamedList.prepend(pDiv);
            });
            clearInterval(timerInterval);
            let timeBanks = {...state.timeBanks};
            timerValues[myPlayerIndex].textContent = formatTime(timeBanks[myPlayerIndex]);
            if (opponentPlayerIndex in timeBanks && timeBanks[opponentPlayerIndex] !== undefined) {
                timerValues[opponentPlayerIndex].textContent = formatTime(timeBanks[opponentPlayerIndex]);
            }
            myTimerBox.classList.remove('active-turn');
            opponentTimerBox.classList.remove('active-turn');
            if (activePlayerIndex === myPlayerIndex) myTimerBox.classList.add('active-turn');
            else opponentTimerBox.classList.add('active-turn');
            timerInterval = setInterval(() => {
                timeBanks[activePlayerIndex] -= 0.05;
                const activeTimerDisplay = (activePlayerIndex === myPlayerIndex) ? myTimerValue : opponentTimerValue;
                activeTimerDisplay.textContent = formatTime(timeBanks[activePlayerIndex]);
                if (timeBanks[activePlayerIndex] <= 10) { activeTimerDisplay.style.color = '#dc3545'; } 
                else { activeTimerDisplay.style.color = '#333'; }
                if (timeBanks[activePlayerIndex] <= 0) clearInterval(timerInterval);
            }, 50);
        }
        
        function startGame(mode) {
            if (!currentUserNickname) return;
            soloBtn.disabled = true; vsBotBtn.disabled = true; pvpBtn.disabled = true; leaderboardBtn.disabled = true;
            if (mode === 'pvp') {
                pvpStatus.textContent = 'Поиск соперника';
                pvpStatus.classList.add('searching-status');
                cancelPvpBtn.classList.remove('hidden');
            }
            socket.emit('start_game', { mode: mode, nickname: currentUserNickname });
        }
        function resetMenu() {
            pvpStatus.textContent = '';
            pvpStatus.classList.remove('searching-status');
            cancelPvpBtn.classList.add('hidden');
            soloBtn.disabled = false; vsBotBtn.disabled = false; pvpBtn.disabled = false; leaderboardBtn.disabled = false;
        }
        
        window.addEventListener('load', () => { const savedNickname = localStorage.getItem('rpl_quiz_nickname'); if (savedNickname) { currentUserNickname = savedNickname; welcomeNickname.textContent = currentUserNickname; showScreen('mainMenu'); } else { showScreen('registration'); } });
        registrationForm.addEventListener('submit', (e) => { e.preventDefault(); const nickname = nicknameInput.value.trim(); registrationStatus.textContent = "Проверяем..."; registrationStatus.className = ''; socket.emit('register_user', { nickname: nickname }); });
        soloBtn.addEventListener('click', () => startGame('solo'));
        vsBotBtn.addEventListener('click', () => startGame('vs_bot'));
        pvpBtn.addEventListener('click', () => startGame('pvp'));
        leaderboardBtn.addEventListener('click', () => socket.emit('get_leaderboard'));
        backToMenuBtn.addEventListener('click', () => resetMenu() & showScreen('mainMenu'));
        cancelPvpBtn.addEventListener('click', () => { socket.emit('cancel_pvp_search'); resetMenu(); });
        guessForm.addEventListener('submit', (e) => { e.preventDefault(); if(isMyTurn) { const guess = guessInput.value; if (guess) { socket.emit('submit_guess', { roomId: clientState.roomId, guess: guess }); guessInput.value = ''; }} });
        surrenderBtn.addEventListener('click', () => { if(surrenderBtn.disabled) return; gameStatus.textContent = "Вы сдались..."; guessInput.disabled = true; surrenderBtn.disabled = true; socket.emit('surrender_round', { roomId: clientState.roomId }); });
        backToMenuFromGameOverBtn.addEventListener('click', () => resetMenu() & showScreen('mainMenu'));
        skipPauseBtn.addEventListener('click', () => {
            skipPauseBtn.disabled = true;
            if(clientState.mode === 'pvp') { skipPauseBtn.textContent = 'Ожидаем второго...'; }
            socket.emit('request_skip_pause', { roomId: clientState.roomId });
        });
        
        socket.on('registration_status', (data) => { if (data.success) { currentUserNickname = data.nickname; localStorage.setItem('rpl_quiz_nickname', currentUserNickname); welcomeNickname.textContent = currentUserNickname; showScreen('mainMenu'); } else { registrationStatus.textContent = data.message; registrationStatus.className = 'error-message'; } });
        socket.on('leaderboard_data', (data) => {
            leaderboardBody.innerHTML = '';
            data.forEach((user, index) => { const row = document.createElement('tr'); row.innerHTML = `<td>${index + 1}</td><td>${user.nickname}</td><td>${user.rating}</td>`; leaderboardBody.appendChild(row); });
            showScreen('leaderboard');
        });
        socket.on('waiting_for_opponent', () => { console.log("Ждем второго игрока."); });
        socket.on('round_started', (state) => { resetMenu(); showScreen('game'); updateGameUI(state); });
        socket.on('turn_updated', (state) => { updateGameUI(state); });
        socket.on('guess_result', (data) => {
            if (data.result === 'correct') gameStatus.textContent = '✅ Верно!';
            else if (data.result === 'correct_typo') gameStatus.textContent = `✅ Верно! (Засчитано как: ${data.corrected_name})`;
            else if (data.result === 'already_named') gameStatus.textContent = 'Такого уже называли!';
            else gameStatus.textContent = '❌ Неверно!';
        });
        socket.on('bot_guessed', (data) => { gameStatus.textContent = `Бот назвал: ${data.guess}`; });
        socket.on('timer_expired', (data) => {
            clearInterval(timerInterval);
            if(timerValues[data.playerIndex]) {
                timerValues[data.playerIndex].textContent = formatTime(0);
                timerValues[data.playerIndex].style.color = '#dc3545';
            }
            gameStatus.textContent = '⏱️ Время вышло!';
            guessInput.disabled = true;
            submitGuessBtn.disabled = true;
            surrenderBtn.disabled = true;
        });
        socket.on('round_summary', (data) => {
            showScreen('summary');
            if (data.mode === 'solo' || data.mode === 'vs_bot' || data.mode === 'pvp') { skipPauseBtn.classList.remove('hidden'); skipPauseBtn.disabled = false; skipPauseBtn.textContent = 'Пропустить'; } 
            else { skipPauseBtn.classList.add('hidden'); }
            summaryHeader.textContent = `Итоги раунда: ${data.clubName}`;
            if (data.mode === 'solo') {
                summaryScoreDisplay.classList.add('hidden');
                summaryBotColumn.classList.add('hidden');
                summaryHumanNameHeader.textContent = "Названные игроки";
            } else {
                summaryScoreDisplay.classList.remove('hidden');
                summaryBotColumn.classList.remove('hidden');
                summaryHumanNameHeader.textContent = data.players[0].nickname;
                summaryBotNameHeader.textContent = data.players[1].nickname;
                summaryScoreDisplay.textContent = `${data.players[0].nickname} ${data.scores[0]} : ${data.scores[1]} ${data.players[1].nickname}`;
            }
            summaryHumanNamedList.innerHTML = ''; summaryBotNamedList.innerHTML = ''; summaryRemainingList.innerHTML = '';
            const allNamedPlayerNames = new Set(data.namedPlayers.map(p => p.name));
            data.namedPlayers.forEach(player => {
                const pDiv = document.createElement('div'); pDiv.className = 'player-name'; pDiv.textContent = player.name;
                if (player.by === 0) summaryHumanNamedList.appendChild(pDiv); else summaryBotNamedList.appendChild(pDiv);
            });
            data.fullPlayerList.forEach(playerName => {
                if (!allNamedPlayerNames.has(playerName)) {
                    const pDiv = document.createElement('div'); pDiv.className = 'player-name'; pDiv.textContent = playerName;
                    summaryRemainingList.appendChild(pDiv);
                }
            });
            let countdown = 10;
            summaryCountdown.textContent = countdown;
            let summaryInterval = setInterval(() => {
                countdown--;
                summaryCountdown.textContent = countdown >= 0 ? countdown : 0;
                if (countdown < 0) clearInterval(summaryInterval);
            }, 1000);
        });
        socket.on('skip_vote_accepted', () => { skipPauseBtn.textContent = '✓ Ждем второго...'; });
        socket.on('skip_vote_update', (data) => { if (clientState.mode === 'pvp') { skipPauseBtn.textContent = `Пропустить (${data.count}/2)`; } });
        socket.on('game_over', (data) => {
            showScreen('gameOver');
            const player1Name = data.players[0].nickname;
            const player2Name = (data.players[1]) ? data.players[1].nickname : 'Бот';
            if (data.final_scores[0] > data.final_scores[1]) { gameOverTitle.textContent = `🏆 Победил ${player1Name}!`; } 
            else if (data.final_scores[1] > data.final_scores[0]) { gameOverTitle.textContent = `🏆 Победил ${player2Name}!`; } 
            else { gameOverTitle.textContent = "🤝 Ничья!"; }
            if (data.end_reason === 'unreachable_score') { earlyEndExplanation.textContent = 'Игра завершена досрочно, так как разница в счете стала больше, чем количество оставшихся раундов.'; earlyEndExplanation.classList.remove('hidden'); } 
            else { earlyEndExplanation.classList.add('hidden'); }
            finalScoreDisplay.textContent = `${player1Name} ${data.final_scores[0]} : ${data.final_scores[1]} ${player2Name}`;
            if (data.mode === 'pvp' && data.rating_changes) {
                const p1_change = data.rating_changes.p1.new - data.rating_changes.p1.old;
                const p2_change = data.rating_changes.p2.new - data.rating_changes.p2.old;
                const p1_sign = p1_change >= 0 ? '+' : ''; const p2_sign = p2_change >= 0 ? '+' : '';
                ratingChangesDisplay.innerHTML = `<div class="rating-change">${player1Name}: ${data.rating_changes.p1.old} → ${data.rating_changes.p1.new} (<span class="${p1_change >= 0 ? 'rating-positive':'rating-negative'}">${p1_sign}${p1_change}</span>)</div><div class="rating-change">${player2Name}: ${data.rating_changes.p2.old} → ${data.rating_changes.p2.new} (<span class="${p2_change >= 0 ? 'rating-positive':'rating-negative'}">${p2_sign}${p2_change}</span>)</div>`;
                ratingChangesDisplay.classList.remove('hidden');
            } else { ratingChangesDisplay.classList.add('hidden'); }
            const tableHead = gameHistoryTable.querySelector('thead');
            const tableBody = gameHistoryTable.querySelector('tbody');
            tableBody.innerHTML = '';
            if (data.mode === 'solo') {
                tableHead.innerHTML = `<tr><th>Клуб</th><th>Названо</th><th>Итог</th></tr>`;
                data.history.forEach(round => {
                    const row = document.createElement('tr');
                    const resultIcon = round.result_type === 'completed' ? '✓' : '⏱️';
                    row.innerHTML = `<td>${round.club_name}</td><td>${round.p1_named}</td><td>${resultIcon}</td>`;
                    tableBody.appendChild(row);
                });
            } else {
                tableHead.innerHTML = `<tr><th>Клуб</th><th>${player1Name}</th><th>${player2Name}</th><th>Итог</th></tr>`;
                data.history.forEach(round => {
                    const row = document.createElement('tr');
                    let p1_score = round.p1_named, p2_score = round.p2_named;
                    if (p1_score > p2_score) p1_score = `<b>${p1_score}</b>`;
                    if (p2_score > p1_score) p2_score = `<b>${p2_score}</b>`;
                    const resultIcon = round.result_type === 'completed' ? '✓' : '⏱️';
                    row.innerHTML = `<td>${round.club_name}</td><td>${p1_score}</td><td>${p2_score}</td><td>${resultIcon}</td>`;
                    tableBody.appendChild(row);
                });
            }
        });
    </script>
</body>
</html>