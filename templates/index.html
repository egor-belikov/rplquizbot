<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–§—É—Ç–±–æ–ª—å–Ω–∞—è –í–∏–∫—Ç–æ—Ä–∏–Ω–∞ –†–ü–õ</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; background-color: #f0f2f5; color: #333; }
        .container { text-align: center; background-color: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); width: 95%; max-width: 500px; }
        .hidden { display: none; }
        button { background-color: #007bff; color: white; border: none; padding: 12px 20px; border-radius: 8px; font-size: 1em; cursor: pointer; transition: background-color 0.2s; margin: 5px; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        .btn-secondary { background-color: #6c757d; }
        .btn-secondary:hover:not(:disabled) { background-color: #5a6268; }
        .btn-danger { background-color: #dc3545; }
        .btn-danger:hover:not(:disabled) { background-color: #c82333; }
        input[type="text"], input[type="password"], input[type="number"] { width: 80%; padding: 10px; border-radius: 8px; border: 1px solid #ddd; margin-bottom: 10px; font-size: 1em; }
        h1, h2, h3 { margin-top: 0; }
        .error-message { color: #dc3545; }
        .auth-toggle { font-size: 0.9em; color: #007bff; cursor: pointer; text-decoration: underline; margin-top: 15px; }
        .lobby-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .open-games-container, .training-modes { margin-top: 20px; }
        .open-game-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border: 1px solid #eee; border-radius: 8px; margin-bottom: 8px; background-color: #fafafa; }
        .open-game-item .info { text-align: left; flex-grow: 1; }
        .open-game-item .info .creator { font-weight: bold; }
        .open-game-item .info .details { font-size: 0.9em; color: #666; }
        .open-game-item .play-btn { white-space: nowrap; margin-left: 10px; }
        .config-form-group { margin-bottom: 15px; }
        .config-form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .time-input-group { display: flex; justify-content: center; align-items: center; gap: 5px; }
        .time-input-group input { width: 50px; text-align: center; }
        .time-input-group button { min-width: 30px; padding: 5px; font-size: 1em; line-height: 1; }
        .rounds-selector { display: flex; justify-content: center; gap: 10px; margin-top: 5px; }
        .rounds-selector label { border: 1px solid #ccc; padding: 8px 12px; border-radius: 8px; cursor: pointer; }
        .rounds-selector input { display: none; }
        .rounds-selector input:checked + label { background-color: #007bff; color: white; border-color: #007bff; }
        /* –°—Ç–∏–ª–∏ –¥–ª—è –∏–≥—Ä–æ–≤–æ–≥–æ —ç–∫—Ä–∞–Ω–∞ –∏ —Ä–µ–π—Ç–∏–Ω–≥–∞ */
        .timers-container { display: flex; justify-content: space-between; margin-bottom: 15px; }
        .timer-box { padding: 10px; border-radius: 8px; border: 1px solid #ddd; width: 48%; }
        .timer-box.active-turn { border-color: #007bff; box-shadow: 0 0 5px rgba(0,123,255,0.5); }
        .timer-value { font-size: 1.5em; font-weight: bold; }
        .live-named-list { max-height: 150px; overflow-y: auto; border: 1px solid #eee; padding: 5px; margin-bottom: 10px; }
        .rating-positive { color: green; }
        .rating-negative { color: red; }
        #leaderboard-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        #leaderboard-table th, #leaderboard-table td { padding: 8px; border: 1px solid #ddd; }
        #leaderboard-table th { background-color: #f2f2f2; }
    </style>
</head>
<body>
    <div id="auth-screen" class="container">
        <div id="login-form-container">
            <h1>–í—Ö–æ–¥</h1>
            <form id="login-form">
                <input type="text" id="login-nickname" placeholder="–ù–∏–∫–Ω–µ–π–º" autocomplete="username">
                <input type="password" id="login-password" placeholder="–ü–∞—Ä–æ–ª—å" autocomplete="current-password">
                <button type="submit">–í–æ–π—Ç–∏</button>
            </form>
            <div id="login-status" class="error-message"></div>
            <p class="auth-toggle" id="show-register-form">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</p>
        </div>
        <div id="register-form-container" class="hidden">
            <h1>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h1>
            <form id="register-form">
                <input type="text" id="register-nickname" placeholder="–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –Ω–∏–∫–Ω–µ–π–º" autocomplete="nickname">
                <input type="password" id="register-password" placeholder="–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –ø–∞—Ä–æ–ª—å" autocomplete="new-password">
                <button type="submit">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
            </form>
            <div id="register-status" class="error-message"></div>
            <p class="auth-toggle" id="show-login-form">–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? –í–æ–π—Ç–∏</p>
        </div>
    </div>

    <div id="lobby-screen" class="container hidden">
        <div class="lobby-header">
            <p style="margin:0;">–ü—Ä–∏–≤–µ—Ç, <b id="welcome-nickname"></b>!</p>
            <button id="logout-btn" class="btn-secondary" style="font-size:0.8em; padding: 6px 12px;">–í—ã–π—Ç–∏</button>
        </div>
        <button id="create-game-btn">–°–æ–∑–¥–∞—Ç—å –∏–≥—Ä—É</button>
        <button id="leaderboard-btn">–†–µ–π—Ç–∏–Ω–≥</button>
        <div class="open-games-container">
            <h3>–û—Ç–∫—Ä—ã—Ç—ã–µ –∏–≥—Ä—ã:</h3>
            <div id="open-games-list"><p>–ù–µ—Ç –æ—Ç–∫—Ä—ã—Ç—ã—Ö –∏–≥—Ä. –°–æ–∑–¥–∞–π—Ç–µ —Å–≤–æ—é!</p></div>
        </div>
        <div class="training-modes">
            <h3>–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞</h3>
            <button id="solo-btn" class="btn-secondary">–ò–≥—Ä–∞—Ç—å –æ–¥–Ω–æ–º—É</button>
            <button id="vs-bot-btn" class="btn-secondary">–ò–≥—Ä–∞—Ç—å —Å –±–æ—Ç–æ–º</button>
        </div>
    </div>
    
    <div id="config-screen" class="container hidden">
        <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–≥—Ä—ã</h2>
        <div class="config-form-group">
            <label for="config-league">–õ–∏–≥–∞</label>
            <input type="text" id="config-league" value="–†–ü–õ" disabled>
        </div>
        <div class="config-form-group">
            <label>–í—Ä–µ–º—è –Ω–∞ —Ä–∞—É–Ω–¥</label>
            <div class="time-input-group">
                <button id="config-time-min-minus">-</button>
                <input type="number" id="config-time-min" value="1" min="0" max="10">
                <span>:</span>
                <input type="number" id="config-time-sec" value="30" min="0" max="59">
                <button id="config-time-sec-plus">+</button>
            </div>
        </div>
        <div class="config-form-group">
            <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–ª—É–±–æ–≤</label>
            <div class="rounds-selector" id="config-rounds">
                <input type="radio" name="rounds" id="rounds-3" value="3"><label for="rounds-3">3</label>
                <input type="radio" name="rounds" id="rounds-5" value="5"><label for="rounds-5">5</label>
                <input type="radio" name="rounds" id="rounds-8" value="8"><label for="rounds-8">8</label>
                <input type="radio" name="rounds" id="rounds-16" value="16" checked><label for="rounds-16">16</label>
            </div>
        </div>
        <button id="submit-create-game-btn">–°–æ–∑–¥–∞—Ç—å –∏–≥—Ä—É</button>
        <button id="back-to-lobby-btn" class="btn-secondary">–ù–∞–∑–∞–¥</button>
    </div>
    
    <div id="game-screen" class="container hidden">
        <h2 id="game-header">–¢—É—Ä 1/16: –ö–ª—É–±</h2>
        <h3 id="score-display">–ò–≥—Ä–æ–∫1 0:0 –ò–≥—Ä–æ–∫2</h3>
        <div class="timers-container">
            <div id="my-timer-box" class="timer-box">
                <div id="my-timer-nickname">–í—ã</div>
                <div id="my-timer-value" class="timer-value">01:30</div>
            </div>
            <div id="opponent-timer-box" class="timer-box">
                <div id="opponent-timer-nickname">–°–æ–ø–µ—Ä–Ω–∏–∫</div>
                <div id="opponent-timer-value" class="timer-value">01:30</div>
            </div>
        </div>
        <div id="game-status">–í–∞—à —Ö–æ–¥...</div>
        <div class="live-named-list" id="live-named-list"></div>
        <form id="guess-form">
            <input type="text" id="guess-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ñ–∞–º–∏–ª–∏—é..." autocomplete="off">
            <button type="submit" id="submit-guess-btn">–û—Ç–≤–µ—Ç–∏—Ç—å</button>
            <button type="button" id="surrender-btn" class="btn-danger">–°–¥–∞—Ç—å—Å—è</button>
        </form>
    </div>

    <div id="leaderboard-screen" class="container hidden">
        <h2>–†–µ–π—Ç–∏–Ω–≥ –∏–≥—Ä–æ–∫–æ–≤</h2>
        <table id="leaderboard-table">
            <thead>
                <tr>
                    <th>#</th>
                    <th>–ù–∏–∫–Ω–µ–π–º</th>
                    <th>–†–µ–π—Ç–∏–Ω–≥</th>
                </tr>
            </thead>
            <tbody id="leaderboard-body">
            </tbody>
        </table>
        <button id="back-to-lobby-from-leaderboard-btn" class="btn-secondary">–ù–∞–∑–∞–¥</button>
    </div>

    <div id="game-over-screen" class="container hidden">
        <h2 id="game-over-title">üèÜ –ü–æ–±–µ–¥–∏–ª –ò–≥—Ä–æ–∫1!</h2>
        <p id="early-end-explanation" class="hidden">–ò–≥—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –¥–æ—Å—Ä–æ—á–Ω–æ.</p>
        <h3 id="final-score-display">–ò–≥—Ä–æ–∫1 10 : 6 –ò–≥—Ä–æ–∫2</h3>
        <div id="rating-changes-display" class="hidden"></div>
        <button id="back-to-lobby-from-game-over-btn">–í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –ª–æ–±–±–∏</button>
    </div>


    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script>
        const socket = io();
        
        const screens = {
            auth: document.getElementById('auth-screen'),
            lobby: document.getElementById('lobby-screen'),
            config: document.getElementById('config-screen'),
            game: document.getElementById('game-screen'),
            gameOver: document.getElementById('game-over-screen'),
            leaderboard: document.getElementById('leaderboard-screen'),
        };

        // --- –≠–ª–µ–º–µ–Ω—Ç—ã DOM ---
        const loginFormContainer = document.getElementById('login-form-container');
        const registerFormContainer = document.getElementById('register-form-container');
        const loginForm = document.getElementById('login-form'), loginNickname = document.getElementById('login-nickname'), loginPassword = document.getElementById('login-password'), loginStatus = document.getElementById('login-status');
        const registerForm = document.getElementById('register-form'), registerNickname = document.getElementById('register-nickname'), registerPassword = document.getElementById('register-password'), registerStatus = document.getElementById('register-status');
        const showRegisterFormBtn = document.getElementById('show-register-form'), showLoginFormBtn = document.getElementById('show-login-form');
        
        const welcomeNickname = document.getElementById('welcome-nickname'), logoutBtn = document.getElementById('logout-btn');
        const createGameBtn = document.getElementById('create-game-btn'), leaderboardBtn = document.getElementById('leaderboard-btn');
        const openGamesList = document.getElementById('open-games-list');
        const soloBtn = document.getElementById('solo-btn'), vsBotBtn = document.getElementById('vs-bot-btn');
        
        const configTimeMin = document.getElementById('config-time-min'), configTimeSec = document.getElementById('config-time-sec');
        const configTimeMinMinus = document.getElementById('config-time-min-minus'), configTimeSecPlus = document.getElementById('config-time-sec-plus');
        const backToLobbyBtn = document.getElementById('back-to-lobby-btn'), submitCreateGameBtn = document.getElementById('submit-create-game-btn');

        const gameHeader = document.getElementById('game-header'), scoreDisplay = document.getElementById('score-display'), gameStatus = document.getElementById('game-status'), guessForm = document.getElementById('guess-form'), guessInput = document.getElementById('guess-input'), liveNamedList = document.getElementById('live-named-list'), surrenderBtn = document.getElementById('surrender-btn'), submitGuessBtn = document.getElementById('submit-guess-btn');
        const myTimerBox = document.getElementById('my-timer-box'), myTimerNickname = document.getElementById('my-timer-nickname'), myTimerValue = document.getElementById('my-timer-value');
        const opponentTimerBox = document.getElementById('opponent-timer-box'), opponentTimerNickname = document.getElementById('opponent-timer-nickname'), opponentTimerValue = document.getElementById('opponent-timer-value');
        const gameOverTitle = document.getElementById('game-over-title'), earlyEndExplanation = document.getElementById('early-end-explanation'), finalScoreDisplay = document.getElementById('final-score-display'), ratingChangesDisplay = document.getElementById('rating-changes-display'), backToLobbyFromGameOverBtn = document.getElementById('back-to-lobby-from-game-over-btn');

        const leaderboardBody = document.getElementById('leaderboard-body'), backToLobbyFromLeaderboardBtn = document.getElementById('back-to-lobby-from-leaderboard-btn');

        let currentUserNickname = null;
        let clientState = {};
        let isMyTurn = false;
        let timerInterval;

        function showScreen(screenName) {
            Object.values(screens).forEach(screen => screen && screen.classList.add('hidden'));
            if (screens[screenName]) screens[screenName].classList.remove('hidden');
        }

        function startGame(mode) {
            if (!currentUserNickname) return alert("–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.");
            socket.emit('start_game', { mode: mode, nickname: currentUserNickname });
        }

        function formatTime(seconds) {
            if (seconds < 0) seconds = 0;
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        }
        
        function updateGameUI(state) {
            clientState = state;
            let myPlayerIndex = state.players[0].sid === socket.id ? 0 : 1;
            if (!state.players[myPlayerIndex] || state.players[myPlayerIndex].sid !== socket.id) {
                 for (const i in state.players) { if (state.players[i].sid === socket.id) { myPlayerIndex = parseInt(i, 10); break; } }
            }

            const opponentPlayerIndex = 1 - myPlayerIndex;
            const activePlayerIndex = state.currentPlayerIndex;
            isMyTurn = (myPlayerIndex === activePlayerIndex);

            gameHeader.textContent = `–¢—É—Ä ${state.round}/${state.totalRounds}: ${state.clubName}`;
            scoreDisplay.textContent = `${state.players[0].nickname} ${state.scores[0]} : ${state.scores[1]} ${state.players[1].nickname}`;
            
            myTimerNickname.textContent = state.players[myPlayerIndex].nickname + ' (–í—ã)';
            opponentTimerNickname.textContent = state.players[opponentPlayerIndex].nickname;

            submitGuessBtn.disabled = !isMyTurn;
            surrenderBtn.disabled = !isMyTurn;
            guessInput.placeholder = isMyTurn ? '–í–≤–µ–¥–∏—Ç–µ —Ñ–∞–º–∏–ª–∏—é...' : '–•–æ–¥ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞...';
            guessInput.disabled = !isMyTurn;
            gameStatus.textContent = isMyTurn ? '–í–∞—à —Ö–æ–¥...' : `–û–∂–∏–¥–∞–µ–º —Ö–æ–¥ –∏–≥—Ä–æ–∫–∞ ${state.players[activePlayerIndex].nickname}...`;

            if(isMyTurn) guessInput.focus();
            
            myTimerBox.classList.toggle('active-turn', isMyTurn);
            opponentTimerBox.classList.toggle('active-turn', !isMyTurn);
            
            clearInterval(timerInterval);
            let timeBanks = {...state.timeBanks};
            myTimerValue.textContent = formatTime(timeBanks[myPlayerIndex]);
            opponentTimerValue.textContent = formatTime(timeBanks[opponentPlayerIndex]);
            
            timerInterval = setInterval(() => {
                timeBanks[activePlayerIndex] -= 0.1;
                const activeTimerDisplay = (activePlayerIndex === myPlayerIndex) ? myTimerValue : opponentTimerValue;
                activeTimerDisplay.textContent = formatTime(timeBanks[activePlayerIndex]);
                if (timeBanks[activePlayerIndex] <= 0) clearInterval(timerInterval);
            }, 100);
        }

        // --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π ---
        showRegisterFormBtn.addEventListener('click', () => { loginFormContainer.classList.add('hidden'); registerFormContainer.classList.remove('hidden'); });
        showLoginFormBtn.addEventListener('click', () => { registerFormContainer.classList.add('hidden'); loginFormContainer.classList.remove('hidden'); });

        loginForm.addEventListener('submit', e => { e.preventDefault(); loginStatus.textContent = "–ü—Ä–æ–≤–µ—Ä–∫–∞..."; socket.emit('login_user', { nickname: loginNickname.value.trim(), password: loginPassword.value }); });
        registerForm.addEventListener('submit', e => { e.preventDefault(); registerStatus.textContent = "–°–æ–∑–¥–∞–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–∞..."; socket.emit('register_user', { nickname: registerNickname.value.trim(), password: registerPassword.value }); });
        logoutBtn.addEventListener('click', () => {
            currentUserNickname = null;
            localStorage.removeItem('rpl_quiz_nickname');
            loginNickname.value = ''; loginPassword.value = ''; registerNickname.value = ''; registerPassword.value = '';
            loginStatus.textContent = ''; registerStatus.textContent = '';
            showScreen('auth');
        });

        createGameBtn.addEventListener('click', () => showScreen('config'));
        backToLobbyBtn.addEventListener('click', () => showScreen('lobby'));
        leaderboardBtn.addEventListener('click', () => socket.emit('get_leaderboard'));
        soloBtn.addEventListener('click', () => startGame('solo'));
        vsBotBtn.addEventListener('click', () => startGame('vs_bot'));
        backToLobbyFromGameOverBtn.addEventListener('click', () => showScreen('lobby'));
        backToLobbyFromLeaderboardBtn.addEventListener('click', () => showScreen('lobby'));


        submitCreateGameBtn.addEventListener('click', () => {
            const settings = {
                time_bank: parseInt(configTimeMin.value) * 60 + parseInt(configTimeSec.value),
                num_rounds: parseInt(document.querySelector('#config-rounds input[name="rounds"]:checked').value)
            };
            socket.emit('create_game', { nickname: currentUserNickname, settings: settings });
            showScreen('lobby');
        });
        
        guessForm.addEventListener('submit', (e) => { e.preventDefault(); if (isMyTurn) { const guess = guessInput.value; if (guess) { socket.emit('submit_guess', { roomId: clientState.roomId, guess: guess }); guessInput.value = ''; } } });

        configTimeMinMinus.addEventListener('click', () => { if (configTimeMin.value > 0) configTimeMin.value = parseInt(configTimeMin.value) - 1; });
        configTimeSecPlus.addEventListener('click', () => {
            let sec = parseInt(configTimeSec.value);
            if (sec < 59) configTimeSec.value = sec + 1;
            else { configTimeSec.value = 0; configTimeMin.value = parseInt(configTimeMin.value) + 1; }
        });

        openGamesList.addEventListener('click', e => {
            if (e.target.classList.contains('play-btn')) {
                const creatorSid = e.target.dataset.creatorSid;
                if (currentUserNickname) {
                    socket.emit('join_game', { creator_sid: creatorSid, nickname: currentUserNickname });
                } else { alert("–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."); }
            }
        });

        // --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ Socket.IO ---
        socket.on('auth_status', data => {
            const statusDiv = document.getElementById(`${data.form}-status`);
            if (data.success) {
                currentUserNickname = data.nickname;
                localStorage.setItem('rpl_quiz_nickname', currentUserNickname);
                welcomeNickname.textContent = currentUserNickname;
                showScreen('lobby');
            } else { if (statusDiv) statusDiv.textContent = data.message; }
        });

        socket.on('update_lobby', data => {
            openGamesList.innerHTML = '';
            if (!data || data.length === 0) {
                openGamesList.innerHTML = '<p>–ù–µ—Ç –æ—Ç–∫—Ä—ã—Ç—ã—Ö –∏–≥—Ä. –°–æ–∑–¥–∞–π—Ç–µ —Å–≤–æ—é!</p>';
                return;
            }
            data.forEach(game => {
                const gameItem = document.createElement('div');
                gameItem.className = 'open-game-item';
                const time_bank = game.settings.time_bank;
                const time_str = `${Math.floor(time_bank / 60)}:${String(time_bank % 60).padStart(2, '0')}`;
                gameItem.innerHTML = `
                    <div class="info">
                        <span class="creator">${game.creator_nickname} (${game.creator_rating})</span>
                        <div class="details">–†–ü–õ, ${game.settings.num_rounds} —Ä–∞—É–Ω–¥–æ–≤, ${time_str}</div>
                    </div>
                    <button class="play-btn" data-creator-sid="${game.creator_sid}">–ò–≥—Ä–∞—Ç—å</button>
                `;
                openGamesList.appendChild(gameItem);
            });
        });
        
        // –û–ë–†–ê–ë–û–¢–ß–ò–ö –î–ê–ù–ù–´–• –†–ï–ô–¢–ò–ù–ì–ê
        socket.on('leaderboard_data', (data) => {
            leaderboardBody.innerHTML = '';
            data.forEach((user, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `<td>${index + 1}</td><td>${user.nickname}</td><td>${user.rating}</td>`;
                leaderboardBody.appendChild(row);
            });
            showScreen('leaderboard');
        });

        socket.on('round_started', (state) => {
            showScreen('game');
            updateGameUI(state);
        });

        socket.on('turn_updated', (state) => {
            updateGameUI(state);
        });

        socket.on('game_over', (data) => {
            showScreen('gameOver');
            const player1Name = data.players[0].nickname;
            const player2Name = (data.players[1]) ? data.players[1].nickname : '–ë–æ—Ç';
            if (data.final_scores[0] > data.final_scores[1]) { gameOverTitle.textContent = `üèÜ –ü–æ–±–µ–¥–∏–ª ${player1Name}!`; } 
            else if (data.final_scores[1] > data.final_scores[0]) { gameOverTitle.textContent = `üèÜ –ü–æ–±–µ–¥–∏–ª ${player2Name}!`; } 
            else { gameOverTitle.textContent = "ü§ù –ù–∏—á—å—è!"; }
            earlyEndExplanation.classList.toggle('hidden', data.end_reason !== 'unreachable_score');
            finalScoreDisplay.textContent = `${player1Name} ${data.final_scores[0]} : ${data.final_scores[1]} ${player2Name}`;
            
            if (data.mode === 'pvp' && data.rating_changes) {
                const p1_change = data.rating_changes.p1.new - data.rating_changes.p1.old;
                const p2_change = data.rating_changes.p2.new - data.rating_changes.p2.old;
                const p1_sign = p1_change >= 0 ? '+' : ''; const p2_sign = p2_change >= 0 ? '+' : '';
                ratingChangesDisplay.innerHTML = `<div class="rating-change">${player1Name}: ${data.rating_changes.p1.old} ‚Üí ${data.rating_changes.p1.new} (<span class="${p1_change >= 0 ? 'rating-positive' : 'rating-negative'}">${p1_sign}${p1_change}</span>)</div><div class="rating-change">${player2Name}: ${data.rating_changes.p2.old} ‚Üí ${data.rating_changes.p2.new} (<span class="${p2_change >= 0 ? 'rating-positive' : 'rating-negative'}">${p2_sign}${p2_change}</span>)</div>`;
                ratingChangesDisplay.classList.remove('hidden');
            } else {
                ratingChangesDisplay.classList.add('hidden');
            }
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        window.addEventListener('load', () => {
            const savedNickname = localStorage.getItem('rpl_quiz_nickname');
            if (savedNickname) {
                currentUserNickname = savedNickname;
                welcomeNickname.textContent = currentUserNickname;
                showScreen('lobby');
            } else { showScreen('auth'); }
        });
    </script>
</body>
</html>