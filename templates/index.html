<!DOCTYPE html>
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–§—É—Ç–±–æ–ª—å–Ω–∞—è –í–∏–∫—Ç–æ—Ä–∏–Ω–∞ –†–ü–õ</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; background-color: #f0f2f5; color: #333; }
        .container { text-align: center; background-color: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); width: 95%; max-width: 500px; }
        .hidden { display: none; }
        button { background-color: #007bff; color: white; border: none; padding: 12px 20px; border-radius: 8px; font-size: 1em; cursor: pointer; transition: background-color 0.2s; margin: 5px; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        .btn-secondary { background-color: #6c757d; }
        .btn-secondary:hover:not(:disabled) { background-color: #5a6268; }
        .btn-danger { background-color: #dc3545; }
        .btn-danger:hover:not(:disabled) { background-color: #c82333; }
        input[type="text"], input[type="password"] { width: 80%; padding: 10px; border-radius: 8px; border: 1px solid #ddd; margin-bottom: 10px; font-size: 1em; }
        h1, h2, h3 { margin-top: 0; }
        .error-message { color: #dc3545; }
        .auth-toggle { font-size: 0.9em; color: #007bff; cursor: pointer; text-decoration: underline; margin-top: 15px; }
        .lobby-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    </style>
</head>
<body>
    <div id="auth-screen" class="container">
        <div id="login-form-container">
            <h1>–í—Ö–æ–¥</h1>
            <form id="login-form">
                <input type="text" id="login-nickname" placeholder="–ù–∏–∫–Ω–µ–π–º" autocomplete="off">
                <input type="password" id="login-password" placeholder="–ü–∞—Ä–æ–ª—å">
                <button type="submit">–í–æ–π—Ç–∏</button>
            </form>
            <div id="login-status" class="error-message"></div>
            <p class="auth-toggle" id="show-register-form">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</p>
        </div>
        <div id="register-form-container" class="hidden">
            <h1>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h1>
            <form id="register-form">
                <input type="text" id="register-nickname" placeholder="–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –Ω–∏–∫–Ω–µ–π–º" autocomplete="off">
                <input type="password" id="register-password" placeholder="–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –ø–∞—Ä–æ–ª—å">
                <button type="submit">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
            </form>
            <div id="register-status" class="error-message"></div>
            <p class="auth-toggle" id="show-login-form">–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? –í–æ–π—Ç–∏</p>
        </div>
    </div>

    <div id="lobby-screen" class="container hidden">
        <div class="lobby-header">
            <p style="margin:0;">–ü—Ä–∏–≤–µ—Ç, <b id="welcome-nickname"></b>!</p>
            <button id="logout-btn" class="btn-secondary" style="font-size:0.8em; padding: 6px 12px;">–í—ã–π—Ç–∏</button>
        </div>
        <button id="create-game-btn">–°–æ–∑–¥–∞—Ç—å –∏–≥—Ä—É</button>
        <button id="leaderboard-btn">–†–µ–π—Ç–∏–Ω–≥</button>
        <div class="open-games-container">
            <h3>–û—Ç–∫—Ä—ã—Ç—ã–µ –∏–≥—Ä—ã:</h3>
            <div id="open-games-list"><p>–ù–µ—Ç –æ—Ç–∫—Ä—ã—Ç—ã—Ö –∏–≥—Ä. –°–æ–∑–¥–∞–π—Ç–µ —Å–≤–æ—é!</p></div>
        </div>
        <div class="training-modes">
            <h3>–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞</h3>
            <button id="solo-btn" class="btn-secondary">–ò–≥—Ä–∞—Ç—å –æ–¥–Ω–æ–º—É</button>
            <button id="vs-bot-btn" class="btn-secondary">–ò–≥—Ä–∞—Ç—å —Å –±–æ—Ç–æ–º</button>
        </div>
    </div>
    
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script>
        const socket = io();
        const screens = { registration: document.getElementById('registration-screen'), lobby: document.getElementById('lobby-screen'), config: document.getElementById('config-screen'), leaderboard: document.getElementById('leaderboard-screen'), game: document.getElementById('game-screen'), summary: document.getElementById('summary-screen'), gameOver: document.getElementById('game-over-screen') };
        let currentUserNickname = null, clientState = {}, timerInterval;
        const registrationForm = document.getElementById('registration-form'), nicknameInput = document.getElementById('nickname-input'), registrationStatus = document.getElementById('registration-status');
        const welcomeNickname = document.getElementById('welcome-nickname'), soloBtn = document.getElementById('solo-btn'), vsBotBtn = document.getElementById('vs-bot-btn'), createGameBtn = document.getElementById('create-game-btn'), openGamesList = document.getElementById('open-games-list');
        const configFormElements = { min: document.getElementById('config-time-min'), sec: document.getElementById('config-time-sec'), rounds: document.getElementById('config-rounds') };
        const backToLobbyBtn = document.getElementById('back-to-lobby-btn'), submitCreateGameBtn = document.getElementById('submit-create-game-btn');
        const leaderboardBtn = document.getElementById('leaderboard-btn'), backToMenuBtn = document.getElementById('back-to-menu-btn'), leaderboardBody = document.getElementById('leaderboard-body');
        const gameHeader = document.getElementById('gameHeader'), scoreDisplay = document.getElementById('score-display'), gameStatus = document.getElementById('game-status'), guessForm = document.getElementById('guess-form'), guessInput = document.getElementById('guess-input'), liveNamedList = document.getElementById('live-named-list'), surrenderBtn = document.getElementById('surrender-btn'), submitGuessBtn = document.getElementById('submit-guess-btn');
        const myTimerBox = document.getElementById('my-timer-box'), myTimerNickname = document.getElementById('my-timer-nickname'), myTimerValue = document.getElementById('my-timer-value');
        const opponentTimerBox = document.getElementById('opponent-timer-box'), opponentTimerNickname = document.getElementById('opponent-timer-nickname'), opponentTimerValue = document.getElementById('opponent-timer-value');
        const summaryHeader = document.getElementById('summaryHeader'), summaryScoreDisplay = document.getElementById('summary-score-display'), summaryHumanColumn = document.getElementById('summary-human-column'), summaryBotColumn = document.getElementById('summary-bot-column'), summaryHumanNameHeader = document.getElementById('summary-human-name-header'), summaryBotNameHeader = document.getElementById('summary-bot-name-header'), summaryHumanNamedList = document.getElementById('summary-human-named-list'), summaryBotNamedList = document.getElementById('summary-bot-named-list'), summaryRemainingList = document.getElementById('summary-remaining-list'), summaryCountdown = document.getElementById('summary-countdown'), skipPauseBtn = document.getElementById('skip-pause-btn');
        const gameOverTitle = document.getElementById('game-over-title'), earlyEndExplanation = document.getElementById('early-end-explanation'), finalScoreDisplay = document.getElementById('final-score-display'), ratingChangesDisplay = document.getElementById('rating-changes-display'), gameHistoryTable = document.getElementById('game-history-table'), backToMenuFromGameOverBtn = document.getElementById('back-to-menu-from-game-over');
        
        let isMyTurn = false;

        function showScreen(screenName) { Object.values(screens).forEach(screen => screen.classList.add('hidden')); if (screens[screenName]) screens[screenName].classList.remove('hidden'); }
        function formatTime(seconds) { if (seconds < 0) seconds = 0; const mins = Math.floor(seconds / 60); const secs = Math.floor(seconds % 60); return `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`; }
        function updateGameUI(state) {
            clientState = state;
            let myPlayerIndex = -1;
            for (const i in state.players) { if (state.players[i].sid === socket.id) { myPlayerIndex = parseInt(i, 10); break; } }
            if (myPlayerIndex === -1 && state.mode === 'solo') myPlayerIndex = 0;
            if (myPlayerIndex === -1 && state.mode !== 'solo') return; 
            const opponentPlayerIndex = 1 - myPlayerIndex;
            const activePlayerIndex = state.currentPlayerIndex;
            isMyTurn = (myPlayerIndex === activePlayerIndex);
            gameHeader.textContent = `–¢—É—Ä ${state.round}/${state.totalRounds}: ${state.clubName}`;
            if (state.mode === 'solo' || !state.players[1]) {
                scoreDisplay.classList.add('hidden');
                opponentTimerBox.classList.add('hidden');
                myTimerNickname.textContent = state.players[0].nickname;
            } else {
                scoreDisplay.classList.remove('hidden');
                opponentTimerBox.classList.remove('hidden');
                scoreDisplay.textContent = `${state.players[0].nickname} ${state.scores[0]} : ${state.scores[1]} ${state.players[1].nickname}`;
                myTimerNickname.textContent = state.players[myPlayerIndex].nickname + ' (–í—ã)';
                opponentTimerNickname.textContent = state.players[opponentPlayerIndex].nickname;
            }
            submitGuessBtn.disabled = !isMyTurn;
            surrenderBtn.disabled = !isMyTurn;
            guessInput.placeholder = isMyTurn ? '–í–≤–µ–¥–∏—Ç–µ —Ñ–∞–º–∏–ª–∏—é...' : '–•–æ–¥ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞...';
            gameStatus.textContent = isMyTurn ? '–í–∞—à —Ö–æ–¥...' : `–û–∂–∏–¥–∞–µ–º —Ö–æ–¥ –∏–≥—Ä–æ–∫–∞ ${state.players[activePlayerIndex].nickname}...`;
            if(isMyTurn) {
                surrenderBtn.classList.remove('btn-secondary');
                surrenderBtn.classList.add('btn-danger');
                guessInput.focus();
            } else {
                surrenderBtn.classList.remove('btn-danger');
                surrenderBtn.classList.add('btn-secondary');
            }
            liveNamedList.innerHTML = '';
            state.namedPlayers.forEach(player => {
                const pDiv = document.createElement('div'); pDiv.className = 'player-name';
                const author = (state.mode !== 'solo' && state.players[1]) ? (player.by === 0 ? state.players[0].nickname : state.players[1].nickname) : '';
                pDiv.textContent = author ? `${player.name} (${author})` : player.name;
                liveNamedList.prepend(pDiv);
            });
            clearInterval(timerInterval);
            let timeBanks = {...state.timeBanks};
            timerValues[myPlayerIndex].textContent = formatTime(timeBanks[myPlayerIndex]);
            if (opponentPlayerIndex in timeBanks && timeBanks[opponentPlayerIndex] !== undefined) {
                timerValues[opponentPlayerIndex].textContent = formatTime(timeBanks[opponentPlayerIndex]);
            }
            myTimerBox.classList.remove('active-turn');
            opponentTimerBox.classList.remove('active-turn');
            if (activePlayerIndex === myPlayerIndex) myTimerBox.classList.add('active-turn');
            else opponentTimerBox.classList.add('active-turn');
            timerInterval = setInterval(() => {
                timeBanks[activePlayerIndex] -= 0.05;
                const activeTimerDisplay = (activePlayerIndex === myPlayerIndex) ? myTimerValue : opponentTimerValue;
                activeTimerDisplay.textContent = formatTime(timeBanks[activePlayerIndex]);
                if (timeBanks[activePlayerIndex] <= 10) { activeTimerDisplay.style.color = '#dc3545'; } 
                else { activeTimerDisplay.style.color = '#333'; }
                if (timeBanks[activePlayerIndex] <= 0) clearInterval(timerInterval);
            }, 50);
        }
        
        function startGame(mode) { if (!currentUserNickname) return; socket.emit('start_game', { mode: mode, nickname: currentUserNickname }); }
                const loginForm = document.getElementById('login-form'), loginNickname = document.getElementById('login-nickname'), loginPassword = document.getElementById('login-password'), loginStatus = document.getElementById('login-status');
        const registerForm = document.getElementById('register-form'), registerNickname = document.getElementById('register-nickname'), registerPassword = document.getElementById('register-password'), registerStatus = document.getElementById('register-status');
        const showRegisterFormBtn = document.getElementById('show-register-form'), showLoginFormBtn = document.getElementById('show-login-form');
        const logoutBtn = document.getElementById('logout-btn');

        showRegisterFormBtn.addEventListener('click', () => {
            document.getElementById('login-form-container').classList.add('hidden');
            document.getElementById('register-form-container').classList.remove('hidden');
        });
        showLoginFormBtn.addEventListener('click', () => {
            document.getElementById('register-form-container').classList.add('hidden');
            document.getElementById('login-form-container').classList.remove('hidden');
        });

        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const nickname = loginNickname.value.trim();
            const password = loginPassword.value;
            loginStatus.textContent = "–ü—Ä–æ–≤–µ—Ä–∫–∞...";
            socket.emit('login_user', { nickname, password });
        });

        registerForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const nickname = registerNickname.value.trim();
            const password = registerPassword.value;
            registerStatus.textContent = "–°–æ–∑–¥–∞–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–∞...";
            socket.emit('register_user', { nickname, password });
        });

        logoutBtn.addEventListener('click', () => {
            currentUserNickname = null;
            localStorage.removeItem('rpl_quiz_nickname');
            showScreen('auth');
            // –û—á–∏—â–∞–µ–º –ø–æ–ª—è —Ñ–æ—Ä–º –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
            loginNickname.value = ''; loginPassword.value = '';
            registerNickname.value = ''; registerPassword.value = '';
            loginStatus.textContent = ''; registerStatus.textContent = '';
        });

        socket.on('auth_status', (data) => {
            const statusDiv = document.getElementById(`${data.form || 'login'}-status`);
            if (data.success) {
                currentUserNickname = data.nickname;
                localStorage.setItem('rpl_quiz_nickname', currentUserNickname);
                welcomeNickname.textContent = currentUserNickname;
                showScreen('lobby');
            } else {
                if (statusDiv) statusDiv.textContent = data.message;
            }
        });
        
        window.addEventListener('load', () => {
            const savedNickname = localStorage.getItem('rpl_quiz_nickname');
            if (savedNickname) {
                currentUserNickname = savedNickname;
                welcomeNickname.textContent = currentUserNickname;
                showScreen('lobby');
            } else {
                showScreen('auth');
            }
        });
        window.addEventListener('load', () => {
            const savedNickname = localStorage.getItem('rpl_quiz_nickname');
            socket.emit('check_status', { nickname: savedNickname });
        });
        registrationForm.addEventListener('submit', (e) => { e.preventDefault(); const nickname = nicknameInput.value.trim(); registrationStatus.textContent = "–ü—Ä–æ–≤–µ—Ä—è–µ–º..."; registrationStatus.className = ''; socket.emit('register_user', { nickname: nickname }); });
        soloBtn.addEventListener('click', () => startGame('solo'));
        vsBotBtn.addEventListener('click', () => startGame('vs_bot'));
        createGameBtn.addEventListener('click', () => showScreen('config'));
        leaderboardBtn.addEventListener('click', () => socket.emit('get_leaderboard'));
        backToMenuBtn.addEventListener('click', () => showScreen('lobby'));
        backToLobbyBtn.addEventListener('click', () => showScreen('lobby'));
        submitCreateGameBtn.addEventListener('click', () => {
            const settings = {
                time_bank: parseInt(configFormElements.min.value) * 60 + parseInt(configFormElements.sec.value),
                num_rounds: parseInt(configFormElements.rounds.value)
            };
            socket.emit('create_game', { nickname: currentUserNickname, settings: settings });
            showScreen('lobby');
        });
        openGamesList.addEventListener('click', (e) => {
            if (e.target.classList.contains('play-btn')) {
                const creatorSid = e.target.dataset.creatorSid;
                socket.emit('join_game', { creator_sid: creatorSid, nickname: currentUserNickname });
            }
        });
        guessForm.addEventListener('submit', (e) => { e.preventDefault(); if (isMyTurn) { const guess = guessInput.value; if (guess) { socket.emit('submit_guess', { roomId: clientState.roomId, guess: guess }); guessInput.value = ''; } } });
        surrenderBtn.addEventListener('click', () => { if (surrenderBtn.disabled) return; gameStatus.textContent = "–í—ã —Å–¥–∞–ª–∏—Å—å..."; guessInput.disabled = true; surrenderBtn.disabled = true; socket.emit('surrender_round', { roomId: clientState.roomId }); });
        backToMenuFromGameOverBtn.addEventListener('click', () => showScreen('lobby'));
        skipPauseBtn.addEventListener('click', () => {
            skipPauseBtn.disabled = true;
            if (clientState.mode === 'pvp') { skipPauseBtn.textContent = '–û–∂–∏–¥–∞–µ–º –≤—Ç–æ—Ä–æ–≥–æ...'; }
            socket.emit('request_skip_pause', { roomId: clientState.roomId });
        });
        backToLobbyFromDisconnectBtn.addEventListener('click', () => {
            disconnectionModal.classList.add('hidden');
            showScreen('lobby');
        });

        socket.on('status_ok', (data) => {
            if (data.needs_registration) {
                showScreen('registration');
            } else {
                currentUserNickname = localStorage.getItem('rpl_quiz_nickname');
                welcomeNickname.textContent = currentUserNickname;
                showScreen('lobby');
                socket.emit('update_lobby_request');
            }
        });
        socket.on('reconnect_to_game', (state) => {
            console.log("Reconnecting to game:", state);
            showScreen('game');
            updateGameUI(state);
        });
        socket.on('registration_status', (data) => { if (data.success) { currentUserNickname = data.nickname; localStorage.setItem('rpl_quiz_nickname', currentUserNickname); welcomeNickname.textContent = currentUserNickname; showScreen('lobby'); } else { registrationStatus.textContent = data.message; registrationStatus.className = 'error-message'; } });
        socket.on('leaderboard_data', (data) => {
            leaderboardBody.innerHTML = '';
            data.forEach((user, index) => { const row = document.createElement('tr'); row.innerHTML = `<td>${index + 1}</td><td>${user.nickname}</td><td>${user.rating}</td>`; leaderboardBody.appendChild(row); });
            showScreen('leaderboard');
        });
        socket.on('round_started', (state) => { showScreen('game'); updateGameUI(state); });
        socket.on('turn_updated', (state) => { updateGameUI(state); });
        socket.on('guess_result', (data) => {
            if (data.result === 'correct') gameStatus.textContent = '‚úÖ –í–µ—Ä–Ω–æ!';
            else if (data.result === 'correct_typo') gameStatus.textContent = `‚úÖ –í–µ—Ä–Ω–æ! (–ó–∞—Å—á–∏—Ç–∞–Ω–æ –∫–∞–∫: ${data.corrected_name})`;
            else if (data.result === 'already_named') gameStatus.textContent = '–¢–∞–∫–æ–≥–æ —É–∂–µ –Ω–∞–∑—ã–≤–∞–ª–∏!';
            else gameStatus.textContent = '‚ùå –ù–µ–≤–µ—Ä–Ω–æ!';
        });
        socket.on('bot_guessed', (data) => { gameStatus.textContent = `–ë–æ—Ç –Ω–∞–∑–≤–∞–ª: ${data.guess}`; });
        socket.on('timer_expired', (data) => {
            clearInterval(timerInterval);
            if (timerValues[data.playerIndex]) {
                timerValues[data.playerIndex].textContent = formatTime(0);
                timerValues[data.playerIndex].style.color = '#dc3545';
            }
            gameStatus.textContent = '‚è±Ô∏è –í—Ä–µ–º—è –≤—ã—à–ª–æ!';
            guessInput.disabled = true;
            submitGuessBtn.disabled = true;
            surrenderBtn.disabled = true;
        });
        socket.on('round_summary', (data) => {
            showScreen('summary');
            if (data.mode === 'solo' || data.mode === 'vs_bot' || data.mode === 'pvp') { skipPauseBtn.classList.remove('hidden'); skipPauseBtn.disabled = false; skipPauseBtn.textContent = '–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å'; } 
            else { skipPauseBtn.classList.add('hidden'); }
            summaryHeader.textContent = `–ò—Ç–æ–≥–∏ —Ä–∞—É–Ω–¥–∞: ${data.clubName}`;
            if (data.mode === 'solo') {
                summaryScoreDisplay.classList.add('hidden');
                summaryBotColumn.classList.add('hidden');
                summaryHumanNameHeader.textContent = "–ù–∞–∑–≤–∞–Ω–Ω—ã–µ –∏–≥—Ä–æ–∫–∏";
            } else {
                summaryScoreDisplay.classList.remove('hidden');
                summaryBotColumn.classList.remove('hidden');
                summaryHumanNameHeader.textContent = data.players[0].nickname;
                summaryBotNameHeader.textContent = data.players[1].nickname;
                summaryScoreDisplay.textContent = `${data.players[0].nickname} ${data.scores[0]} : ${data.scores[1]} ${data.players[1].nickname}`;
            }
            summaryHumanNamedList.innerHTML = ''; summaryBotNamedList.innerHTML = ''; summaryRemainingList.innerHTML = '';
            const allNamedPlayerNames = new Set(data.namedPlayers.map(p => p.name));
            data.namedPlayers.forEach(player => {
                const pDiv = document.createElement('div'); pDiv.className = 'player-name'; pDiv.textContent = player.name;
                if (player.by === 0) summaryHumanNamedList.appendChild(pDiv); else summaryBotNamedList.appendChild(pDiv);
            });
            data.fullPlayerList.forEach(playerName => {
                if (!allNamedPlayerNames.has(playerName)) {
                    const pDiv = document.createElement('div'); pDiv.className = 'player-name'; pDiv.textContent = playerName;
                    summaryRemainingList.appendChild(pDiv);
                }
            });
            let countdown = 10;
            summaryCountdown.textContent = countdown;
            let summaryInterval = setInterval(() => {
                countdown--;
                summaryCountdown.textContent = countdown >= 0 ? countdown : 0;
                if (countdown < 0) clearInterval(summaryInterval);
            }, 1000);
        });
        socket.on('skip_vote_accepted', () => { skipPauseBtn.textContent = '‚úì –ñ–¥–µ–º –≤—Ç–æ—Ä–æ–≥–æ...'; });
        socket.on('skip_vote_update', (data) => { if (clientState.mode === 'pvp') { skipPauseBtn.textContent = `–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å (${data.count}/2)`; } });
        socket.on('game_over', (data) => {
            showScreen('gameOver');
            const player1Name = data.players[0].nickname;
            const player2Name = (data.players[1]) ? data.players[1].nickname : '–ë–æ—Ç';
            if (data.final_scores[0] > data.final_scores[1]) { gameOverTitle.textContent = `üèÜ –ü–æ–±–µ–¥–∏–ª ${player1Name}!`; } 
            else if (data.final_scores[1] > data.final_scores[0]) { gameOverTitle.textContent = `üèÜ –ü–æ–±–µ–¥–∏–ª ${player2Name}!`; } 
            else { gameOverTitle.textContent = "ü§ù –ù–∏—á—å—è!"; }
            if (data.end_reason === 'unreachable_score') { earlyEndExplanation.textContent = '–ò–≥—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –¥–æ—Å—Ä–æ—á–Ω–æ, —Ç–∞–∫ –∫–∞–∫ —Ä–∞–∑–Ω–∏—Ü–∞ –≤ —Å—á–µ—Ç–µ —Å—Ç–∞–ª–∞ –±–æ–ª—å—à–µ, —á–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è —Ä–∞—É–Ω–¥–æ–≤.'; earlyEndExplanation.classList.remove('hidden'); } 
            else { earlyEndExplanation.classList.add('hidden'); }
            finalScoreDisplay.textContent = `${player1Name} ${data.final_scores[0]} : ${data.final_scores[1]} ${player2Name}`;
            if (data.mode === 'pvp' && data.rating_changes) {
                const p1_change = data.rating_changes.p1.new - data.rating_changes.p1.old;
                const p2_change = data.rating_changes.p2.new - data.rating_changes.p2.old;
                const p1_sign = p1_change >= 0 ? '+' : ''; const p2_sign = p2_change >= 0 ? '+' : '';
                ratingChangesDisplay.innerHTML = `<div class="rating-change">${player1Name}: ${data.rating_changes.p1.old} ‚Üí ${data.rating_changes.p1.new} (<span class="${p1_change >= 0 ? 'rating-positive' : 'rating-negative'}">${p1_sign}${p1_change}</span>)</div><div class="rating-change">${player2Name}: ${data.rating_changes.p2.old} ‚Üí ${data.rating_changes.p2.new} (<span class="${p2_change >= 0 ? 'rating-positive' : 'rating-negative'}">${p2_sign}${p2_change}</span>)</div>`;
                ratingChangesDisplay.classList.remove('hidden');
            } else {
                ratingChangesDisplay.classList.add('hidden');
            }
            const tableHead = gameHistoryTable.querySelector('thead');
            const tableBody = gameHistoryTable.querySelector('tbody');
            tableBody.innerHTML = '';
            if (data.mode === 'solo') {
                tableHead.innerHTML = `<tr><th>–ö–ª—É–±</th><th>–ù–∞–∑–≤–∞–Ω–æ</th><th>–ò—Ç–æ–≥</th></tr>`;
                data.history.forEach(round => {
                    const row = document.createElement('tr');
                    const resultIcon = round.result_type === 'completed' ? '‚úì' : '‚è±Ô∏è';
                    row.innerHTML = `<td>${round.club_name}</td><td>${round.p1_named}</td><td>${resultIcon}</td>`;
                    tableBody.appendChild(row);
                });
            } else {
                tableHead.innerHTML = `<tr><th>–ö–ª—É–±</th><th>${player1Name}</th><th>${player2Name}</th><th>–ò—Ç–æ–≥</th></tr>`;
                data.history.forEach(round => {
                    const row = document.createElement('tr');
                    let p1_score = round.p1_named, p2_score = round.p2_named;
                    if (p1_score > p2_score) p1_score = `<b>${p1_score}</b>`;
                    if (p2_score > p1_score) p2_score = `<b>${p2_score}</b>`;
                    const resultIcon = round.result_type === 'completed' ? '‚úì' : '‚è±Ô∏è';
                    row.innerHTML = `<td>${round.club_name}</td><td>${p1_score}</td><td>${p2_score}</td><td>${resultIcon}</td>`;
                    tableBody.appendChild(row);
                });
            }
        });
        socket.on('update_lobby', (data) => {
            openGamesList.innerHTML = '';
            if (data.length === 0) {
                openGamesList.innerHTML = '<p>–ù–µ—Ç –æ—Ç–∫—Ä—ã—Ç—ã—Ö –∏–≥—Ä. –°–æ–∑–¥–∞–π—Ç–µ —Å–≤–æ—é!</p>';
                return;
            }
            data.forEach(game => {
                const gameItem = document.createElement('div');
                gameItem.className = 'open-game-item';
                const time_bank = game.settings.time_bank;
                const time_str = `${Math.floor(time_bank / 60)}:${String(time_bank % 60).padStart(2, '0')}`;
                gameItem.innerHTML = `
                    <div class="info">
                        <span class="creator">${game.creator_nickname} (${game.creator_rating})</span>
                        <span class="details">–†–ü–õ, ${game.settings.num_rounds} —Ä–∞—É–Ω–¥–æ–≤, ${time_str}</span>
                    </div>
                    <button class="play-btn" data-creator-sid="${game.creator_sid}">–ò–≥—Ä–∞—Ç—å</button>
                `;
                openGamesList.appendChild(gameItem);
            });
        });
        socket.on('opponent_disconnected', (data) => {
            clearInterval(timerInterval);
            disconnectionModal.classList.remove('hidden');
        });
    </script>
</body>
</html>